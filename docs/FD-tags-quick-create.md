# 功能设计（FD）：标签管理与快速新建 TXT

## 1. 背景与目标
- 提示词需要可被标签快速筛选与批量维护。
- 新建常用短语 `.txt` 应在搜索界面完成，减少手动进入目录创建的成本。

## 2. 范围（MVP）
- 搜索结果支持 Ctrl 多选，右键批量添加/移除标签。
- 搜索框支持 `#标签` 过滤，支持与关键词组合与多标签 AND。
- 搜索框右侧、设置按钮左侧新增 `+`，快速新建 `.txt` 并用系统默认编辑器打开。

## 3. 不在范围
- 搜索结果行内显示标签并可点击过滤（后续再评估）。

## 4. 标签规则
- 扁平结构，不区分大小写（存储为小写）。
- 仅允许中英文数字，长度 1–10。
- 非法标签直接阻止并提示。

## 5. 数据结构
- 元数据文件：`<prompts_dir>/.tags.json`
- 内容格式：
```json
{
  "version": 1,
  "updated_at": 1730000000,
  "tags_by_path": {
    "Examples/邮件回复 #email.txt": ["email", "回复"],
    "foo.txt": ["tag1", "tag2"]
  }
}
```
- `tags_by_path` 使用相对路径（相对 `prompts_dir`），统一用 `/` 分隔。
- 标签来源优先级：`.tags.json` > 文件名/目录兜底。

## 6. 交互与流程

### 6.1 批量添加标签
1. Ctrl 多选搜索结果。
2. 右键 → “添加标签”。
3. 输入框内以空格分隔多个标签。
4. 通过校验后写入 `.tags.json`，刷新结果。

### 6.2 批量移除标签
1. Ctrl 多选搜索结果。
2. 右键 → “移除标签”。
3. 弹出可选标签列表（来自选中项的标签并集）。
4. 选择后写入 `.tags.json`，刷新结果。

### 6.3 标签过滤搜索
- 搜索框输入 `#标签` 触发过滤。
- `#tag foo` 表示先按标签过滤，再按关键词匹配。
- 多标签为 AND：`#tag1 #tag2` 同时满足。
- 标签自动补全（输入 `#` 时展示已有标签）。

### 6.4 快速新建 TXT
1. 点击 `+`。
2. 输入文件名（必填）。
3. 在 `prompts_dir` 下创建 `文件名.txt`。
4. 同名则阻止创建并提示。
5. 使用系统默认文本编辑器打开。
6. 保存并关闭后纳入搜索结果。

## 7. 后端接口（Tauri）
- `create_prompt_file(name: String) -> Result<String, String>`
  - 返回创建后的文件路径。
- `update_prompt_tags(paths: Vec<String>, add: Vec<String>, remove: Vec<String>) -> Result<(), String>`
  - 写入 `.tags.json` 并触发刷新。

## 8. 错误处理
- 标签非法：提示“标签仅允许中英文数字，长度 1–10”。
- 未选中结果：右键菜单置灰或提示“请选择项目”。
- 文件已存在：提示“文件已存在，无法创建”。
- 读取/写入失败：提示“标签保存失败，请重试”。

## 9. 兼容与迁移
- 沿用原有基于文件名/目录的标签解析作为兜底。
- 一旦用户通过 UI 修改标签，以 `.tags.json` 为最终来源。

## 10. 测试要点（TDD）
- `normalize_tag`：中英文数字通过，非法字符/超长拒绝。
- `.tags.json`：不存在时加载为默认值；保存后可回读一致。
- 标签优先级：元数据覆盖文件名/目录标签。
- `#标签` 过滤与多标签 AND 行为。

## 11. 风险与限制
- 用户手动重命名文件会导致元数据映射失效（按相对路径存储）。
- “保存后才显示”需要监听文件写入变化（空文件不入索引）。
